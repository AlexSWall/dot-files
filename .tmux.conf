# - Misc Setup
# - Key bindings
# - Visuals
# - Status Bar
# - Plugins


# == Misc Setup ==

# Make Tmux windows non-login shells
# set -g default-command "${SHELL}"

set -sg escape-time 0

# Enable mouse mode (tmux 2.1 and above)
set -g mouse on

# don't rename windows automatically
set -g allow-rename off

# Enable vi mode
set -g status-keys vi
set -g mode-keys vi

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# And renumber them when one is deleted
set-option -g renumber-windows on

# Focus events for some plugins
set -g focus-events on


# == Key bindings ==

unbind C-b
set-option -g prefix C-a
bind C-b send-prefix  # Make Ctrl-b send a prefix to a remote session
bind a send-prefix

# -----

# Make F12 toggle between sending tmux commands to local and remote.
# https://bit.ly/2yPzSTu

bind -T root F12 \
		  set prefix None \; \
		  set key-table off \; \
		  #set status-style "fg=$color_status_text,bg=$color_window_off_status_bg" \; \
		  set window-status-current-format "#[fg=$color_window_off_status_bg,bg=$color_window_off_status_current_bg]$separator_powerline_right#[default] #I:#W# #[fg=$color_window_off_status_current_bg,bg=$color_window_off_status_bg]$separator_powerline_right#[default]" \; \
		  set window-status-current-style "fg=$color_dark,bold,bg=$color_window_off_status_current_bg" \; \
		  if -F '#{pane_in_mode}' 'send-keys -X cancel' \; \
		  refresh-client -S \; \

		  bind -T off F12 \
			  set -u prefix \; \
			  set -u key-table \; \
			  set -u status-style \; \
			  set -u window-status-current-style \; \
			  set -u window-status-current-format \; \
			  refresh-client -S

# -----

# reload config file
bind r source-file ~/.tmux.conf

# split panes using | and -
bind | split-window -h  # (prefix)
bind - split-window -v  # (prefix)
bind -n M-| split-window -h  # (alt)
bind -n M-- split-window -v  # (alt)
unbind '"'
unbind %

# kill pane with alt-W
bind -n M-W kill-pane

# tmux buffers <--> system buffers
bind C-p run "pbpaste | tmux load-buffer -"
bind C-y run "tmux save-buffer - | pbcopy"

# copy mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Update the working directory to the current directory
bind -n M-u attach-session -t . -c '#{pane_current_path}'

# -- Navigation --

# quick pane cycling
unbind C-A
bind C-A select-pane -t :.+

# - Alt-arrow (panes),
# - Prefix-[hjkl] (panes),
# - Alt-[hjkl] (panes),
# - Alt-[1-9] (windows)

# switch panes using Alt-arrow without prefix
bind -n M-Left  select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up    select-pane -U
bind -n M-Down  select-pane -D

# switch panes using {hjkl} (with prefix)
bind h select-pane -L
bind l select-pane -R
bind k select-pane -U
bind j select-pane -D

# switch panes using Ctrl-{hjkl} without prefix
bind -n C-h select-pane -L
bind -n C-l select-pane -R
bind -n C-k select-pane -U
bind -n C-j select-pane -D

# Select tmux window with meta-number
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# ---------------------
# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator

is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

bind-key -n 'M-h' if-shell "$is_vim" 'send-keys M-h' 'select-pane -L'
bind-key -n 'M-j' if-shell "$is_vim" 'send-keys M-j' 'select-pane -D'
bind-key -n 'M-k' if-shell "$is_vim" 'send-keys M-k' 'select-pane -U'
bind-key -n 'M-l' if-shell "$is_vim" 'send-keys M-l' 'select-pane -R'

bind-key -T copy-mode-vi 'M-h' select-pane -L
bind-key -T copy-mode-vi 'M-j' select-pane -D
bind-key -T copy-mode-vi 'M-k' select-pane -U
bind-key -T copy-mode-vi 'M-l' select-pane -R
# ---------------------

# == Visuals ==

# Colours: https://i.stack.imgur.com/e63et.png
# colour232 = black; colour255 = white

# -- General --

set -sa terminal-overrides ',xterm-256color:Tc'
set -s default-terminal "screen-256color"
set -as terminal-overrides ',xterm*:sitm=\E[3m'
# set -as terminal-overrides ',xterm*:sitm=\E[3m'

setw -g monitor-activity off  # Don't monitor the activity of windows

setw -g mode-style 'fg=colour255 bg=colour238'

# -- Panes --
set -g pane-border-style 'fg=colour237 bg=colour233'
set -g pane-active-border-style 'bg=colour233 fg=colour14'


# == Status Bar ==

# -- General --
set -g status-interval 1  # Update once a second
set -g status-style 'bg=colour233 fg=colour255' # For the otherwise-unassigned sections of the bar

set -g window-status-bell-style 'fg=colour255 bg=colour1 bold'  # Set status line style for windows with a bell alert
set -g message-style 'fg=colour250 bg=colour234 bold'  # Set status line message style

# -- Positioning --
set -g status-position bottom  # Put the status bar on the bottom (as opposed to top)
set -g status-justify left  # Position of the window list component of the status line (vs centre or right)

# -- Status-Left --
set -g status-left ''
set -g status-left-style ''
set -g status-left-length 20

# -- Window-Status-Styles (centre-left) --
# General (non-current)
set -g window-status-style 'bg=colour236'
set -g window-status-format ' #[fg=colour209]#I#[fg=colour252]:#W#[fg=colour244]#F '

# Current
set -g window-status-current-style 'bg=colour238'
set -g window-status-current-format ' #[fg=colour14]#I#[fg=colour255]:#W#[fg=colour14]#F '

# -- Status-Right --
keys_off_text="#([ $(tmux show-option -qv key-table) = 'off' ] && echo 'OFF ')"

set -g @prefix_highlight_fg 'colour75'
set -g @prefix_highlight_bg 'colour233'
set -g status-right-style 'fg=colour68'
set -g status-right "#{prefix_highlight}$keys_off_text#{simple_git_status}#(whoami)@#H  %d/%m %H:%M:%S "
set -g status-right-length 100

# set -g status-right '#{prefix_highlight}%H:%M:%S'
# set -g status-right-length 13


# == Plugins ==

set -g @plugin 'tmux-plugins/tpm' # TPM: prefix-{I,U,alt-u} to {install,update,uninstall}

# -- Restoring --

set -g @plugin 'tmux-plugins/tmux-resurrect'  # Prefix Ctrl-{s(ave),r(estore)}
set -g @plugin 'tmux-plugins/tmux-continuum'
# set -g @continuum-restore 'on'

# -- Copy mode --

# Mac-specific:
# set -g default-command "reattach-to-user-namespace -l bash"  # Fix Mac-Tmux pbcopy/pbpaste

set -g @plugin 'tmux-plugins/tmux-copycat'  # Prefix, Ctrl-{f(ile),u(rl)}, n/N to navigate

set -g @plugin 'tmux-plugins/tmux-yank'  # Copy-mode: y=clipboard, Y=CLI; Normal: Prefix-y: CLI -> pbcopy

set -g @plugin 'tmux-plugins/tmux-open'  # Copy-mode: o=open, Ctrl-o=$EDITOR, S=search

# -- Interfaces --

# set -g @plugin 'AlexSWall/tmux-spotify-panel'  # Spotify panel: Meta-s 

# -- Visuals --

# Status-bar
set -g @plugin 'kristijanhusak/tmux-simple-git-status'  # gives #{simple_git_status} 
# set -g @plugin 'AlexSWall/tmux-spotify-status-tags'  # gives #{spotify_{status,artist,album,track}}
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'  # gives #{prefix_highlight}

# -- Finalisation --

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run -b '~/.tmux/plugins/tpm/tpm'

if-shell 'test -n "$SSH_CLIENT"' 'source-file ~/.tmux.remote.conf'
